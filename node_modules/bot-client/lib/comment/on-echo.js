const { path } = require('ramda')
function init ({ onBroadcast, loginInfo }) {
  let called = false
  function onEcho (cb) {
    if (called) return
    called = true

    onBroadcast('comment::created', message => {
      const userId = loginInfo.getUserId(message.teamId)
      if (path(['data', 'content', 'streamId'], message)) {
        return
      }
      if (!path(['data', 'content', 'to'], message)) {
        return
      }
      if (message.data.content.from === userId) {
        return
      }
      if (!message.data.content.to.find(id => id === userId)) {
        return
      }
      if (!path(['data', 'content', 'att', '0', 'data'], message)) {
        return
      }
      if (typeof message.data.content.att[0].data.text !== 'string') {
        return
      }
      if (!message.data.content.att[0].data.text.match(/^\/echo/)) {
        return
      }

      cb(message)
    })
  }

  return onEcho
}

module.exports = init
