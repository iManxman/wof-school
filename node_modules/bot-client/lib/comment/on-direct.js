const { path } = require('ramda')
function init ({ onBroadcast, loginInfo }) {
  function onDirect (cb) {
    if (typeof cb !== 'function') {
      cb = () => {}
      console.log('WARN', 'must provide function to comment.onDirect')
    }
    onBroadcast('comment::created', message => {
      const userId = loginInfo.getUserId(message.teamId)
      if (path(['data', 'content', 'streamId'], message)) {
        return
      }
      if (!path(['data', 'content', 'to'], message)) {
        return
      }
      if (message.data.content.from === userId) {
        return
      }
      if (!message.data.content.to.find(id => id === userId)) {
        return
      }
      if (path(['data', 'content', 'att', '0', 'data', 'text'], message) &&
        message.data.content.att[0].data.text.match(/^\/echo/)) {
        return
      }
      cb(message)
    })
  }

  return onDirect
}

module.exports = init
