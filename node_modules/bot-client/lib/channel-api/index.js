const socketio = require('socket.io-client')
function init ({ email, channelToken }) {
  const empty = () => {}
  let channelBotUrl = 'http://channel-bots.pm-channel-bots:3000'
  if (process.env.WS_ENDPOINT_CHANNEL) {
    channelBotUrl = process.env.WS_ENDPOINT_CHANNEL
  }

  const socket = socketio(channelBotUrl, {query: `login=${email}&secret=${channelToken}`})
  socket.on('error', reason => {
    console.log(`connecting as channel error ${reason}`)
  })

  function onError (cb) {
    if (typeof cb !== 'function') {
      console.log('WARN cb must be a function')
      cb = empty
    }
    socket.on('error', cb)
  }
  function onMessage (cb) {
    if (typeof cb !== 'function') {
      console.log('WARN cb must be a function')
      cb = empty
    }
    socket.on('messageSent', cb)
  }
  function sendMessage (payload) {
    return new Promise((resolve, reject) => {
      socket.emit('message', payload, response => {
        if (response.code !== 200) {
          reject(response)
        }
        resolve(response)
      })
    })
  }
  return {
    onError,
    onMessage,
    sendMessage
  }
}

module.exports = init
